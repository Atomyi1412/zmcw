name: Build DesktopPet (macOS DMG and Windows EXE Installer)

on:
  push:
    branches: [ main, dev ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main, dev ]

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.9'
  VERSION: ${{ github.ref_type == 'tag' && github.ref_name || format('build-{0}', github.run_number) }}

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Prepare app icon (macOS)
        run: |
          if [ -f assets/icon.png ]; then
            mkdir -p build/icons.iconset
            for SIZE in 16 32 64 128 256 512; do
              sips -z $SIZE $SIZE assets/icon.png --out build/icons.iconset/icon_${SIZE}x${SIZE}.png >/dev/null
              DOUBLE=$((SIZE*2))
              sips -z $DOUBLE $DOUBLE assets/icon.png --out build/icons.iconset/icon_${SIZE}x${SIZE}@2x.png >/dev/null
            done
            iconutil -c icns build/icons.iconset -o assets/app.icns
            echo "Generated assets/app.icns"
          else
            echo "assets/icon.png not found, skip icon generation"
          fi

      - name: Build app with PyInstaller (spec)
        run: |
          pyinstaller DesktopPet.spec --noconfirm

      - name: Create DMG
        run: |
          hdiutil create -volname DesktopPet -srcfolder dist/DesktopPet.app DesktopPet-${{ env.VERSION }}-macOS.dmg

      - name: Upload artifacts (DMG)
        uses: actions/upload-artifact@v4
        with:
          name: DesktopPet-macOS-${{ env.VERSION }}
          path: DesktopPet-${{ env.VERSION }}-macOS.dmg

      - name: Upload artifacts (raw .app)
        uses: actions/upload-artifact@v4
        with:
          name: DesktopPet-macOS-app-${{ env.VERSION }}
          path: dist/DesktopPet.app

      - name: Skip release publish (centralized in 'release' job)
        if: startsWith(github.ref, 'refs/tags/')
        run: echo "Release handled in centralized 'release' job"

  build-windows:
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
          pip install pyinstaller
          pip install pillow

      - name: Prepare app icon (Windows)
        shell: pwsh
        run: |
          if (Test-Path "assets\icon.png") {
            python -c "from PIL import Image; img=Image.open('assets/icon.png').convert('RGBA'); sizes=[(16,16),(24,24),(32,32),(48,48),(64,64),(128,128),(256,256)]; img.save('assets/app.ico', sizes=sizes); print('Generated assets/app.ico')"
          } else {
            Write-Host "assets/icon.png not found, skip icon generation"
          }

      - name: Build app with PyInstaller
        shell: pwsh
        run: |
          Write-Host "Building with PyInstaller..."
          $pyArgs = @("--noconfirm", "--name", "DesktopPet", "--windowed", "--add-data=assets;assets")
          if (Test-Path "assets\app.ico") { $pyArgs += @("--icon", "assets\app.ico") }
          $pyArgs += "main.py"
          python -m PyInstaller @$pyArgs
          
          if (Test-Path "dist\DesktopPet") {
            Write-Host "✓ PyInstaller build successful"
            Write-Host "Contents:"
            Get-ChildItem "dist\DesktopPet" | ForEach-Object { Write-Host "  - $($_.Name)" }
          } else {
            Write-Error "PyInstaller build failed"
            exit 1
          }

      - name: Upload PyInstaller output
        uses: actions/upload-artifact@v4
        with:
          name: DesktopPet-Windows-folder-${{ env.VERSION }}
          path: dist/DesktopPet

      - name: Create EXE installer with Inno Setup
        shell: pwsh
        run: |
          Write-Host "Creating EXE installer with Inno Setup..."
          
          # Check if Inno Setup is available
          $innoPath = @(
            "C:\Program Files (x86)\Inno Setup 6",
            "C:\Program Files\Inno Setup 6"
          ) | Where-Object { Test-Path $_ } | Select-Object -First 1
          
          if ($innoPath) {
            Write-Host "Found Inno Setup at: $innoPath"
            $env:Path += ";$innoPath"
            
            # Create output directory
            New-Item -ItemType Directory -Force -Path "dist\installer"
            
            # Get absolute paths
            $currentDir = Get-Location
            $sourceDir = "$currentDir\dist\DesktopPet"
            $outputDir = "$currentDir\dist\installer"
            
            Write-Host "Current directory: $currentDir"
            Write-Host "Source directory: $sourceDir"
            Write-Host "Output directory: $outputDir"
            
            # Verify source exists
            if (Test-Path $sourceDir) {
              Write-Host "✓ Source directory exists"
              Get-ChildItem $sourceDir | ForEach-Object { Write-Host "  - $($_.Name)" }
            } else {
              Write-Error "Source directory not found: $sourceDir"
              exit 1
            }
            
            # Run Inno Setup with absolute paths
            $issCommand = "iscc"
            $issScript = "$currentDir\installer\desktop_pet.iss"
            $issArgs = @(
              $issScript,
              "/DAppVersion=${{ env.VERSION }}",
              "/DSourceDir=$sourceDir",
              "/DOutputDir=$outputDir",
              "/DOutBase=DesktopPet-${{ env.VERSION }}-Windows-Setup"
            )
            if (Test-Path "$currentDir\assets\app.ico") { $issArgs += "/DIconFile=$currentDir\assets\app.ico" }
            
            Write-Host "Running: $issCommand $($issArgs -join ' ')"
            
            try {
              & $issCommand @issArgs
              
              if (Test-Path "$outputDir\*.exe") {
                $exeFile = Get-ChildItem "$outputDir\*.exe" | Select-Object -First 1
                $exeSize = [math]::Round($exeFile.Length / 1MB, 2)
                Write-Host "✓ EXE installer created: $($exeFile.Name) ($exeSize MB)"
              } else {
                Write-Error "Installer creation failed - no EXE file found"
                exit 1
              }
            } catch {
              Write-Error "Inno Setup failed: $_"
              exit 1
            }
          } else {
            Write-Warning "Inno Setup not found in standard locations. Installing via Chocolatey..."
            choco install innosetup --no-progress -y
            
            # Re-check installation path
            $innoPath = @(
              "C:\Program Files (x86)\Inno Setup 6",
              "C:\Program Files\Inno Setup 6"
            ) | Where-Object { Test-Path $_ } | Select-Object -First 1
            
            if (-not $innoPath) {
              Write-Error "Inno Setup installation failed or path not found."
              exit 1
            }
            
            Write-Host "Inno Setup installed at: $innoPath"
            $env:Path += ";$innoPath"
            
            # Create output directory
            New-Item -ItemType Directory -Force -Path "dist\installer"
            
            # Get absolute paths
            $currentDir = Get-Location
            $sourceDir = "$currentDir\dist\DesktopPet"
            $outputDir = "$currentDir\dist\installer"
            
            # Run Inno Setup
            $issCommand = "iscc"
            $issScript = "$currentDir\installer\desktop_pet.iss"
            $issArgs = @(
              $issScript,
              "/DAppVersion=${{ env.VERSION }}",
              "/DSourceDir=$sourceDir",
              "/DOutputDir=$outputDir",
              "/DOutBase=DesktopPet-${{ env.VERSION }}-Windows-Setup"
            )
            if (Test-Path "$currentDir\assets\app.ico") { $issArgs += "/DIconFile=$currentDir\assets\app.ico" }
            
            Write-Host "Running after install: $issCommand $($issArgs -join ' ')"
            & $issCommand @issArgs
            
            if (Test-Path "$outputDir\*.exe") {
              $exeFile = Get-ChildItem "$outputDir\*.exe" | Select-Object -First 1
              $exeSize = [math]::Round($exeFile.Length / 1MB, 2)
              Write-Host "✓ EXE installer created: $($exeFile.Name) ($exeSize MB)"
            } else {
              Write-Error "Installer creation failed - no EXE file found (post-install)"
              exit 1
            }
          }

      - name: Upload installer (if created)
        uses: actions/upload-artifact@v4
        if: hashFiles('dist/installer/*.exe') != ''
        with:
          name: DesktopPet-Windows-Installer-${{ env.VERSION }}
          path: dist/installer/*.exe

      - name: Skip release publish (centralized in 'release' job')
        if: startsWith(github.ref, 'refs/tags/')
        run: echo "Release handled in centralized 'release' job"

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs:
      - build-macos
      - build-windows
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download macOS DMG artifact
        uses: actions/download-artifact@v4
        with:
          name: DesktopPet-macOS-${{ env.VERSION }}
          path: release
      - name: Download Windows installer artifact
        uses: actions/download-artifact@v4
        with:
          name: DesktopPet-Windows-Installer-${{ env.VERSION }}
          path: release
      - name: Publish Release for tag ${{ env.VERSION }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*.dmg
            release/*.exe
          overwrite_files: true
          fail_on_unmatched_files: false